# templates/serviceaccount.yaml

apiVersion: v1
kind: ServiceAccount
metadata:
  name: wazuh-backup-sa
  namespace: {{ .Values.namespace }}

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: wazuh-backup-role
  namespace: {{ .Values.namespace }}
rules:
  # Allow reading PVCs
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["get", "list"]

  # Allow reading the AWS creds Secret
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: ["{{ .Values.aws.secretName }}"]
    verbs: ["get"]

  # Allow reading and patching all Wazuh StatefulSets
  - apiGroups: ["apps"]
    resources: ["statefulsets"]
    resourceNames:
      {{- range $componentName, $config := .Values.backup.components }}
      {{- if $config.enabled }}
      - {{ $config.statefulsetName }}
      {{- end }}
      {{- end }}
    verbs:
      - get
      - list
      - patch
      - update

  # Allow operations on the scale subresource for all components
  - apiGroups: ["apps"]
    resources: ["statefulsets/scale"]
    resourceNames:
      {{- range $componentName, $config := .Values.backup.components }}
      {{- if $config.enabled }}
      - {{ $config.statefulsetName }}
      {{- end }}
      {{- end }}
    verbs:
      - get
      - patch
      - update

  # Allow creating and managing CronJobs
  - apiGroups: ["batch"]
    resources: ["cronjobs"]
    verbs: ["get", "list", "create", "update", "patch", "delete"]

  # Allow managing Jobs (created by CronJobs)
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: wazuh-backup-rolebinding
  namespace: {{ .Values.namespace }}
subjects:
  - kind: ServiceAccount
    name: wazuh-backup-sa
    namespace: {{ .Values.namespace }}
roleRef:
  kind: Role
  name: wazuh-backup-role
  apiGroup: rbac.authorization.k8s.io
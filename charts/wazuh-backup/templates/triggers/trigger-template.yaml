# templates/triggers/trigger-template.yaml
# Fixed trigger templates for hybrid mode with renamed components

# Template for Master backups
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: wazuh-backup-master-template
  namespace: {{ .Values.namespace }}
spec:
  params:
    - name: s3BucketName
      description: "S3 bucket for backups"
      default: "{{ .Values.backup.s3.bucketName }}"
    - name: s3EndpointUrl
      description: "Optional S3 endpoint URL"
      default: "{{ .Values.backup.s3.endpointUrl }}"
    - name: triggeredBy
      description: "How the backup was triggered (cronjob, manual, webhook, etc.)"
      default: "manual"
  resourcetemplates:
    - apiVersion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        generateName: wazuh-backup-master-
        namespace: {{ .Values.namespace }}
        labels:
          app.kubernetes.io/name: wazuh-component-backup
          component: master
          triggered-by: "$(tt.params.triggeredBy)"
        annotations:
          backup.wazuh.io/component: "master"
          backup.wazuh.io/triggered-by: "$(tt.params.triggeredBy)"
      spec:
        serviceAccountName: wazuh-backup-sa
        pipelineRef:
          name: wazuh-component-backup
        params:
          - name: componentName
            value: "master"
          - name: statefulsetName
            value: "{{ .Values.backup.components.master.statefulsetName }}"
          - name: statefulsetNamespace
            value: "{{ .Values.namespace }}"
          - name: replicas
            value: "{{ .Values.backup.components.master.replicas }}"
          - name: sourcePvcName
            value: "{{ .Values.backup.components.master.pvcName }}"
          - name: sourcePvcPath
            value: "{{ include "backup.sourcePath" .Values.backup.components.master }}"
          - name: includePaths
            value: "{{ include "backup.includePaths" .Values.backup.components.master }}"
          - name: excludePatterns
            value: "{{ include "backup.excludePatterns" .Values.backup.components.master }}"
          - name: backupSubdir
            value: "{{ .Values.backup.components.master.backupSubdir }}"
          - name: s3BucketName
            value: "$(tt.params.s3BucketName)"
          - name: s3EndpointUrl
            value: "$(tt.params.s3EndpointUrl)"

---
# Template for Indexer backups
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: wazuh-backup-indexer-template
  namespace: {{ .Values.namespace }}
spec:
  params:
    - name: s3BucketName
      description: "S3 bucket for backups"
      default: "{{ .Values.backup.s3.bucketName }}"
    - name: s3EndpointUrl
      description: "Optional S3 endpoint URL"
      default: "{{ .Values.backup.s3.endpointUrl }}"
    - name: triggeredBy
      description: "How the backup was triggered"
      default: "manual"
  resourcetemplates:
    - apiVersion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        generateName: wazuh-backup-indexer-
        namespace: {{ .Values.namespace }}
        labels:
          app.kubernetes.io/name: wazuh-component-backup
          component: indexer
          triggered-by: "$(tt.params.triggeredBy)"
        annotations:
          backup.wazuh.io/component: "indexer"
          backup.wazuh.io/triggered-by: "$(tt.params.triggeredBy)"
      spec:
        serviceAccountName: wazuh-backup-sa
        pipelineRef:
          name: wazuh-component-backup
        params:
          - name: componentName
            value: "indexer"
          - name: statefulsetName
            value: "{{ .Values.backup.components.indexer.statefulsetName }}"
          - name: statefulsetNamespace
            value: "{{ .Values.namespace }}"
          - name: replicas
            value: "{{ .Values.backup.components.indexer.replicas }}"
          - name: sourcePvcName
            value: "{{ .Values.backup.components.indexer.pvcName }}"
          - name: sourcePvcPath
            value: "{{ include "backup.sourcePath" .Values.backup.components.indexer }}"
          - name: includePaths
            value: "{{ include "backup.includePaths" .Values.backup.components.indexer }}"
          - name: excludePatterns
            value: "{{ include "backup.excludePatterns" .Values.backup.components.indexer }}"
          - name: backupSubdir
            value: "{{ .Values.backup.components.indexer.backupSubdir }}"
          - name: s3BucketName
            value: "$(tt.params.s3BucketName)"
          - name: s3EndpointUrl
            value: "$(tt.params.s3EndpointUrl)"

---
# Template for Worker backups
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: wazuh-backup-worker-template
  namespace: {{ .Values.namespace }}
spec:
  params:
    - name: s3BucketName
      description: "S3 bucket for backups"
      default: "{{ .Values.backup.s3.bucketName }}"
    - name: s3EndpointUrl
      description: "Optional S3 endpoint URL"
      default: "{{ .Values.backup.s3.endpointUrl }}"
    - name: triggeredBy
      description: "How the backup was triggered"
      default: "manual"
  resourcetemplates:
    - apiVersion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        generateName: wazuh-backup-worker-
        namespace: {{ .Values.namespace }}
        labels:
          app.kubernetes.io/name: wazuh-component-backup
          component: worker
          triggered-by: "$(tt.params.triggeredBy)"
        annotations:
          backup.wazuh.io/component: "worker"
          backup.wazuh.io/triggered-by: "$(tt.params.triggeredBy)"
      spec:
        serviceAccountName: wazuh-backup-sa
        pipelineRef:
          name: wazuh-component-backup
        params:
          - name: componentName
            value: "worker"
          - name: statefulsetName
            value: "{{ .Values.backup.components.worker.statefulsetName }}"
          - name: statefulsetNamespace
            value: "{{ .Values.namespace }}"
          - name: replicas
            value: "{{ .Values.backup.components.worker.replicas }}"
          - name: sourcePvcName
            value: "{{ .Values.backup.components.worker.pvcName }}"
          - name: sourcePvcPath
            value: "{{ include "backup.sourcePath" .Values.backup.components.worker }}"
          - name: includePaths
            value: "{{ include "backup.includePaths" .Values.backup.components.worker }}"
          - name: excludePatterns
            value: "{{ include "backup.excludePatterns" .Values.backup.components.worker }}"
          - name: backupSubdir
            value: "{{ .Values.backup.components.worker.backupSubdir }}"
          - name: s3BucketName
            value: "$(tt.params.s3BucketName)"
          - name: s3EndpointUrl
            value: "$(tt.params.s3EndpointUrl)"
# =============================================================================
# WAZUH HELM CHART - DEFAULT VALUES
# =============================================================================
# Documentation: https://documentation.wazuh.com/current/deployment-options/deploying-with-kubernetes/
# For quick start, only modify sections marked with [REQUIRED] or [RECOMMENDED]
# =============================================================================


# =============================================================================
# SECTION 1: GLOBAL SETTINGS
# =============================================================================

global:
  # [REQUIRED] Your domain for accessing Wazuh Dashboard
  domain: wazuh.example.com

  # [RECOMMENDED] Wazuh version to deploy
  version: "4.14.2"

  # Container registry (leave empty for Docker Hub)
  imageRegistry: ""
  imagePullSecrets: []

  # Default StorageClass (null = cluster default)
  storageClassName: ~

# Override chart name in resource names
nameOverride: ""
fullnameOverride: ""

# Labels/annotations added to ALL resources
commonLabels: {}
commonAnnotations:
  "kubernetes.io/description": '{{ include "common.names.fullname" $ }} cluster'


# =============================================================================
# SECTION 2: STORAGE CONFIGURATION
# =============================================================================
# See values-storage-examples.yaml for provider-specific configurations.

storageClasses:
  '{{ include "wazuh.storageClassName" $ }}':
    enabled: false
    provisioner: ""
    parameters: {}
    volumeBindingMode: ""
    reclaimPolicy: Delete


# =============================================================================
# SECTION 3: WAZUH INDEXER (OpenSearch)
# =============================================================================

indexer:
  replicas: 2

  image:
    registry: docker.io
    repository: wazuh/wazuh-indexer
    tag: '{{ .Values.global.version }}'
    pullPolicy: IfNotPresent

  # [RECOMMENDED] Change default credentials
  auth:
    username: admin
    password: ""
  authSecret: ~

  # --- Keycloak/OIDC Integration ---
  # For Keycloak setup instructions, see: docs/authentication/keycloak-setup.md
  keycloak:
    enabled: false                    # Set to true to use Keycloak/OIDC authentication
    roles_key: wazuh_roles           # OIDC claim key containing user roles
    subject_key: preferred_username  # OIDC claim key for username
    openid_connect_url: "https://<keycloak-url>/realms/<realm>/.well-known/openid-configuration"
    client_id: ~                     # Keycloak client ID
    client_secret: ~                 # Keycloak client secret
    # Use existing secret for OIDC credentials (takes precedence over client_id/client_secret)
    existingSecret: ~                # Name of existing secret containing credentials
    existingSecretClientIdKey: "client_id"        # Key in secret for client_id
    existingSecretClientSecretKey: "client_secret" # Key in secret for client_secret
    scope: "openid profile email"    # OIDC scopes to request
    base_redirect_url: ~             # Optional: Override redirect URL (useful behind proxy)
    # Custom roles, role mappings, and tenants - see values-multitenancy.yaml for examples
    roles_mapping: ~
    roles: ~
    tenants: ~

  # =============================================================================
  # MULTI-TENANCY CONFIGURATION
  # =============================================================================
  # Country-based multi-tenancy with admin isolation per region.
  # For full configuration, see: values-multitenancy.yaml
  #
  # Deploy with multi-tenancy:
  #   helm install wazuh ./charts/wazuh \
  #     -f values.yaml \
  #     -f values-talos-ceph.yaml \
  #     -f values-multitenancy.yaml
  # =============================================================================
  multiTenancy:
    enabled: false          # Set to true in values-multitenancy.yaml
    tenants: {}
    internalUsers: {}
    roles: {}
    rolesMapping: {}

  # --- Security Admin Job ---
  # Applies security configuration (roles, tenants, users) after indexer starts
  securityAdmin:
    enabled: false          # Enabled automatically with multiTenancy
    maxRetries: 30
    retryInterval: 10

  # --- Persistence ---
  persistence:
    size: 500Mi
    storageClassName: ~
    accessModes: [ReadWriteOnce]

  # --- Java Heap ---
  env:
    - name: OPENSEARCH_JAVA_OPTS
      value: '-Xms1g -Xmx1g -Dlog4j2.formatMsgNoLookups=true'

  resources: ~
  affinity: ~

  # --- Index Lifecycle Management ---
  lifecycle:
    enabled: true
    alerts:
      warmAfterDays: 7
      deleteAfterDays: 90
    archives:
      deleteAfterDays: 30
    statistics:
      deleteAfterDays: 56
    monitoring:
      deleteAfterDays: 28

  # --- Alerting Monitors ---
  alerting:
    enabled: true
    monitors:
      unauthorizedApps:
        intervalMinutes: 5
        lookbackMinutes: 5
        throttleMinutes: 30
      criticalTools:
        intervalMinutes: 1
        lookbackMinutes: 2
        throttleMinutes: 5
      remoteAccess:
        intervalMinutes: 5
        lookbackMinutes: 5
        throttleMinutes: 15
      securityRemoval:
        intervalMinutes: 5
        lookbackMinutes: 5
        throttleMinutes: 5
      # New monitors
      newAgentRegistered:
        enabled: true
        intervalMinutes: 5
        throttleMinutes: 60
      anomalyDetected:
        enabled: true
        intervalMinutes: 5
        throttleMinutes: 30
      agentDisconnected:
        enabled: true
        intervalMinutes: 60           # Check every hour
        noEventPeriodDays: 7          # Alert if no events for 7 days (configurable)
        throttleMinutes: 1440         # Once per day per agent
      bruteForceAttack:
        enabled: true
        intervalMinutes: 5
        lookbackMinutes: 10
        threshold: 5                  # Number of failed attempts to trigger
        throttleMinutes: 15
      rootkitMalwareDetected:
        enabled: true
        intervalMinutes: 1
        throttleMinutes: 5
      criticalSeverityAlert:
        enabled: true
        intervalMinutes: 1
        minLevel: 12                  # Minimum rule level for critical alerts
        throttleMinutes: 5
      dailySecuritySummary:
        enabled: true
        scheduleHour: 8               # 8:00 AM
        scheduleMinute: 0
        scheduleTimezone: "Europe/Berlin"
      weeklyComplianceReport:
        enabled: true
        scheduleDay: "MON"            # Monday
        scheduleHour: 8               # 8:00 AM
        scheduleMinute: 0
        scheduleTimezone: "Europe/Berlin"
      deprecatedOsReport:
        enabled: true
        scheduleHour: 8               # 8:01 AM (1 min after daily summary)
        scheduleMinute: 1
        scheduleTimezone: "Europe/Berlin"
        # Deprecated OS versions to check for
        deprecatedVersions:
          windows: ["Windows 7", "Windows 8", "Server 2008", "Server 2012", "Windows XP", "Windows Vista"]
          ubuntu: ["14", "16", "18", "19", "21", "23"]
          centos: ["5", "6", "7", "8"]
          rhel: ["5", "6", "7"]
          debian: ["7", "8", "9", "10"]
          amazonLinux: ["1", "2", "2018.03"]
          # macOS versions (10.x = deprecated, 11 Big Sur EOL Sep 2023, 12 Monterey EOL late 2024)
          macOS: ["10.9", "10.10", "10.11", "10.12", "10.13", "10.14", "10.15", "11", "12"]
      # Phishing and Anonymizer Detection
      phishingDetection:
        enabled: true
        intervalMinutes: 5
        lookbackMinutes: 10
        throttleMinutes: 15
      anonymizerTorDetection:
        enabled: true
        intervalMinutes: 5
        lookbackMinutes: 10
        throttleMinutes: 30
      cryptominingDns:
        enabled: true
        intervalMinutes: 1            # Fast detection for crypto mining
        lookbackMinutes: 5
        throttleMinutes: 5
      # Daily Unauthorized Apps Report - lists all unauthorized apps with agent IDs
      dailyUnauthorizedAppsReport:
        enabled: true
        scheduleHour: 8               # 8:02 AM
        scheduleMinute: 2
        scheduleTimezone: "UTC"

  # --- Anomaly Detection ---
  anomalyDetection:
    enabled: true
    detectors:
      fimChanges:
        enabled: true
      highSeverity:
        enabled: true
      blacklistProcess:
        enabled: true  # Detects running blacklisted apps via audit/process events
      perAgent:
        enabled: true  # Security anomalies (high severity, auth, malware, network)
      # Additional detectors
      unauthorizedAccess:
        enabled: true  # Detects spikes in authentication failures (brute force, invalid logins)
      offHoursActivity:
        enabled: true  # Detects activity outside business hours (22:00-06:00, weekends)
      privilegeEscalation:
        enabled: true  # Detects sudo/su abuse, permission changes
      networkAnomalies:
        enabled: true  # Detects unusual firewall blocks, connection attempts
      scaCompliance:
        enabled: true  # Detects SCA compliance failures
      logVolume:
        enabled: true  # Detects unusual spikes/drops in overall log volume

  # --- Init Containers ---
  initContainers:
    volume-mount-hack:
      image: busybox
      command: ['sh', '-c', 'chown -R 1000:1000 /var/lib/wazuh-indexer']
      volumeMounts:
        - name: '{{ include "common.names.fullname" $ }}-indexer'
          mountPath: /var/lib/wazuh-indexer
    increase-the-vm-max-map-count:
      image: busybox
      command: ['sysctl', '-w', 'vm.max_map_count=262144']
      securityContext:
        privileged: true
    config-init:
      image: ghcr.io/adorsys-gis/envsubt:main-7917c58
      command:
        - /bin/sh
        - -c
        - |
          set -e
          apk add --update --no-cache libintl gettext apache2-utils
          export INDEXER_PASSWORD_BCRYPT=$(htpasswd -bnBC 12 "" $INDEXER_PASSWORD | tr -d ':\n')
          export DASHBOARD_USERNAME_BCRYPT=$(htpasswd -bnBC 12 "" $DASHBOARD_PASSWORD | tr -d ':\n')
          envsubst < /workdir/internal_users.yml > /processed/internal_users.yml
      envFrom:
        - secretRef:
            name: '{{ include "secret.indexer-auth" $ }}'
        - secretRef:
            name: '{{ include "secret.dashboard-auth" $ }}'
      volumeMounts:
        - name: indexer-conf
          mountPath: /workdir/internal_users.yml
          subPath: internal_users.yml
          readOnly: true
        - name: wazuh-config-temp
          mountPath: /processed


# =============================================================================
# SECTION 3.5: FILEBEAT CONFIGURATION
# =============================================================================

filebeat:
  archives:
    enabled: false
  ssl:
    verification_mode: "full"


# =============================================================================
# SECTION 4: WAZUH MANAGER - MASTER
# =============================================================================

master:
  replicaCount: 1

  image:
    registry: docker.io
    repository: wazuh/wazuh-manager
    tag: '{{ .Values.global.version }}'
    pullPolicy: IfNotPresent

  ingress:
    enabled: false
    className: ""
    host: "{{ .Values.global.domain }}"
    tls: true

  initContainers: {}
  env: []
  envFrom: []

  volumes:
    - name: manager-backup
      persistentVolumeClaim:
        claimName: '{{ include "common.names.fullname" $ }}-manager-backup'

  volumeMounts: []

  persistence:
    size: 50Gi
    storageClassName: ~
    accessModes: [ReadWriteOnce]

  resources: ~
  affinity: ~

  securityContext:
    capabilities:
      add: ["SYS_CHROOT"]
    privileged: true


# =============================================================================
# SECTION 5: WAZUH MANAGER - WORKER
# =============================================================================

worker:
  replicaCount: 2

  image:
    registry: docker.io
    repository: wazuh/wazuh-manager
    tag: '{{ .Values.global.version }}'
    pullPolicy: IfNotPresent

  initContainers: {}
  env: []
  envFrom: []

  volumes:
    - name: manager-backup
      persistentVolumeClaim:
        claimName: '{{ include "common.names.fullname" $ }}-manager-backup'

  volumeMounts: []

  persistence:
    size: 50Gi
    storageClassName: ~
    accessModes: [ReadWriteOnce]

  resources: ~
  affinity: ~

  securityContext:
    capabilities:
      add: ["SYS_CHROOT"]
    privileged: true


# =============================================================================
# SECTION 6: WAZUH MANAGER - WORKER INTEGRATION
# =============================================================================
# Dedicated worker for cloud integrations (AWS, Azure, GitHub).

worker_integration:
  enabled: false
  replicaCount: 1

  image:
    registry: docker.io
    repository: wazuh/wazuh-manager
    tag: '{{ .Values.global.version }}'
    pullPolicy: IfNotPresent

  initContainers: {}
  env: []
  envFrom: []

  volumes:
    - name: manager-backup
      persistentVolumeClaim:
        claimName: '{{ include "common.names.fullname" $ }}-manager-backup'

  volumeMounts: []

  persistence:
    size: 50Gi
    storageClassName: ~
    accessModes: [ReadWriteOnce]

  resources: ~
  affinity: ~

  securityContext:
    capabilities:
      add: ["SYS_CHROOT"]
    privileged: true


# =============================================================================
# SECTION 7: WAZUH DASHBOARD
# =============================================================================

dashboard:
  image:
    registry: docker.io
    repository: wazuh/wazuh-dashboard
    tag: '{{ .Values.global.version }}'
    pullPolicy: IfNotPresent

  auth:
    username: kibanaserver
    password: "mS05mw_0a?-nMGfM"
  authSecret: ~

  # Enable/disable sidebar modules
  modules:
    pci: true
    gdpr: true
    hipaa: true
    nist: true
    tsc: true
    audit: true
    oscap: false
    ciscat: false
    aws: false
    gcp: false
    azure: false
    virustotal: false
    osquery: false
    docker: false

  # Create index patterns for Discover tab
  indexPatterns:
    enabled: false
    archives:
      enabled: true
    alerts:
      enabled: false
    monitoring:
      enabled: false
    statistics:
      enabled: false

  ingress:
    enabled: false
    className: ""
    host: "{{ .Values.global.domain }}"
    port: 5601
    tls:
      enabled: true
      useSecret: false

  env:
    - name: OPENSEARCH_JAVA_OPTS
      value: '-Xms1g -Xmx1g -Dlog4j2.formatMsgNoLookups=true'

  volumes: []
  volumeMounts: []
  resources: ~

  branding:
    logo:
      defaultUrl: "https://wazuh-assets-bucket.s3.eu-central-1.amazonaws.com/images/favicon-dark.svg"
    mark:
      defaultUrl: "https://wazuh-assets-bucket.s3.eu-central-1.amazonaws.com/images/favicon-dark.svg"
    loadingLogo:
      defaultUrl: "https://wazuh-assets-bucket.s3.eu-central-1.amazonaws.com/images/favicon-dark.svg"
    faviconUrl: "https://wazuh-assets-bucket.s3.eu-central-1.amazonaws.com/images/favicon-dark.svg"
    applicationTitle: "Wazuh | Adorsys"


# =============================================================================
# SECTION 9: SERVICES
# =============================================================================

svcs:
  # Master: API (55000) + Registration (1515)
  '{{ include "common.names.fullname" $ }}':
    enabled: true
    type: LoadBalancer
    selector:
      app: '{{ include "common.names.fullname" $ }}-manager'
      node-type: master
    ports:
      - name: api
        port: 55000
        targetPort: api
        protocol: TCP
      - name: registration
        port: 1515
        targetPort: registration
        protocol: TCP

  # Worker: Agent events (1514)
  '{{ include "common.names.fullname" $ }}-worker':
    enabled: true
    type: LoadBalancer
    selector:
      app: '{{ include "common.names.fullname" $ }}-manager'
      node-type: worker
    ports:
      - name: agents-events
        port: 1514
        targetPort: agents-events
        protocol: TCP

  # Cluster: Internal communication
  '{{ include "common.names.fullname" $ }}-cluster':
    enabled: true
    type: ClusterIP
    clusterIP: None
    selector:
      app: '{{ include "common.names.fullname" $ }}-manager'
    ports:
      - name: cluster
        port: 1516
        protocol: TCP
        targetPort: cluster

  # Dashboard: Web UI (5601)
  '{{ include "common.names.fullname" $ }}-dashboard':
    enabled: true
    type: ClusterIP
    selector:
      app: '{{ include "common.names.fullname" $ }}-dashboard'
    ports:
      - name: dashboard
        port: 5601
        protocol: TCP
        targetPort: 5601


# =============================================================================
# SECTION 10: CLUSTER & SECURITY
# =============================================================================

cluster:
  secret:
    enabled: true
  secretName: ~

  # [REQUIRED] Root CA secret name for TLS
  rootCaSecretName: "example-secret-name"

  auth:
    # [REQUIRED] Cluster key (generate with: openssl rand -hex 16)
    key: "dfbb2c1b9d679c39af94d5c1c821c952"
    # Use existing secret for cluster auth key (takes precedence over key)
    existingSecret: ~                # Name of existing secret containing auth key
    existingSecretKeyName: "auth_key" # Key in secret for auth key
    # Password-based agent registration (simpler for homelab)
    usePassword: false
    agentPassword: ""

  config:
    smtp:
      server: smtp.example.wazuh.com
      from: ossecm@example.wazuh.com
      to: recipient@example.wazuh.com
      max_per_hour: 12

  logging:
    maxSize: "50M"
    compress: true
    rotatedLogsToKeep: 7

  cleanup:
    enabled: true
    vdFeedRetentionDays: 7
    fimDiffRetentionDays: 14
    alertsRetentionDays: 30

  # Custom rules and decoders (inline YAML)
  rules: {}
  decoders: {}


# =============================================================================
# SECTION 11: API CREDENTIALS
# =============================================================================

apiCred:
  authSecret: ~
  auth:
    username: wazuh-wui
    password: "9Y0m^%^Cx4zx@6=X"


# =============================================================================
# SECTION 12: NOTIFICATIONS
# =============================================================================

notification:
  slack:
    enabled: false
    webhookUrl: https://<example>.slack.com/services/hooks/<webhook>
    externalSecret: ~

  email:
    enabled: false
    accountName: "wazuh-smtp-account"
    host: "smtp.gmail.com"
    port: 587
    method: "starttls"
    from: "wazuh-alerts@example.com"
    username: ""
    password: ""
    existingSecret: ~
    recipients:
      - "security-team@example.com"

  # GitHub Issues notification - creates tickets for security alerts
  github:
    enabled: false
    owner: ""           # GitHub org or user (e.g., "skyengpro")
    repo: ""            # Repository name (e.g., "security-alerts")
    token: ""           # GitHub PAT with repo:write scope
    labels:             # Labels to add to created issues
      - "security-alert"
      - "wazuh"


# =============================================================================
# SECTION 13: INTEGRATIONS
# =============================================================================

integration:
  jira:
    enabled: false
    webhookUrl: https://<example>.jira.com/services/hooks/<webhook>
    apikey: ""
    projectKey: WAZUH
    # Use existing secret for Jira credentials (takes precedence over webhookUrl/apikey)
    existingSecret: ~              # Name of existing secret
    existingSecretWebhookKey: "webhook_url"  # Key in secret for webhook URL
    existingSecretApikeyKey: "apikey"        # Key in secret for API key

  github: []
  # Example with inline secret:
  #   - secret: <GitHub PAT>
  #     orgs: [myorg1, myorg2]
  # Example with existing secret:
  #   - existingSecret: "my-github-secret"
  #     existingSecretTokenKey: "token"
  #     orgs: [myorg1, myorg2]

  azure:
    tenantDomain: ~
    secrets:
      create: false
      existingSecret: ~
    # Azure auth credentials (used when secrets.existingSecret is not set)
    auth:
      log:
        application_id: ~
        application_key: ~
      graph:
        application_id: ~
        application_key: ~
      storage:
        application_id: ~
        application_key: ~
    logAnalytics:
      enabled: false
      workspace: ~
      queries: []
    graph:
      enabled: false
      queries: []
    storage:
      enabled: false
      containers: []

  aws:
    enable: false
    profile: ~
    roleArn: ~
    awsOrganizationId: ~
    secrets:
      create: false
      existingSecret: "ext-wazuh-aws-secrets"
      credentials: ~
      config: ~
    cloudtrail:
      enabled: false
      bucketName: ~
      interval: 30m
      onlyLogsAfter: ~
    config:
      enabled: false
      bucketName: ~
      awsAccountIds: ~
    securityHub:
      enabled: false
      sqsName: ~
      interval: 1h
    guardduty:
      enabled: false
      bucketName: ~
      awsAccountIds: ~
      onlyLogsAfter: ~


# =============================================================================
# SECTION 14: EXTRA VOLUMES (PVCs)
# =============================================================================

extraVolumeConfigs:
  '{{ include "common.names.fullname" $ }}-manager-backup':
    enabled: true
    accessModes: [ReadWriteOnce]
    resources:
      requests:
        storage: 500Mi
    storageClassName: ~


# =============================================================================
# SECTION 15: ADDITIONAL RESOURCES
# =============================================================================

configmaps: {}
secrets: {}


# =============================================================================
# SECTION 16: CERTIFICATE JOB
# =============================================================================

secretjob:
  enabled: true
  additionalAnnotations:
    "helm.sh/hook": pre-install

  image:
    registry: docker.io
    repository: alpine
    tag: latest
    pullPolicy: IfNotPresent

  secretImage:
    registry: docker.io
    repository: bitnamilegacy/kubectl
    tag: latest
    pullPolicy: IfNotPresent

  serviceAccount:
    name: wazuh-certs
<!--
  AdGuard Home DNS Security Rules
  CONSOLIDATED VERSION - AdGuard-specific detection only

  NOTE: Generic threat patterns (cryptomining, phishing, etc.) are handled by
  rules.dns-monitoring.xml. This file focuses on AdGuard-specific features.

  Rule ID Range: 110000-110049
-->
<group name="adguard,dns,">

  <!-- Base rule for AdGuard DNS logs -->
  <rule id="110000" level="0">
    <match>^{"T":"</match>
    <description>AdGuard Home DNS query log</description>
    <group>adguard,dns_base,</group>
  </rule>

  <!-- ================================================== -->
  <!-- ADGUARD FILTER STATUS RULES                        -->
  <!-- ================================================== -->

  <!-- DNS query allowed (silenced - too noisy) -->
  <rule id="110001" level="0">
    <if_sid>110000</if_sid>
    <field name="Result.IsFiltered">false</field>
    <description>AdGuard: DNS query allowed - $(QH)</description>
    <group>adguard_allowed,</group>
  </rule>

  <!-- DNS query blocked by filter -->
  <rule id="110002" level="5">
    <if_sid>110000</if_sid>
    <field name="Result.IsFiltered">true</field>
    <description>AdGuard: DNS query BLOCKED - $(QH)</description>
    <group>adguard_blocked,</group>
  </rule>

  <!-- Multiple blocked queries from same client (potential malware) -->
  <rule id="110003" level="10" frequency="10" timeframe="60">
    <if_matched_sid>110002</if_matched_sid>
    <same_field>IP</same_field>
    <description>AdGuard: High volume of blocked DNS queries from $(IP) - possible malware</description>
    <group>adguard_malware_suspect,</group>
  </rule>

  <!-- ================================================== -->
  <!-- ADGUARD-SPECIFIC THREAT DETECTION                  -->
  <!-- These use AdGuard's JSON fields (QH, QT, IP)       -->
  <!-- ================================================== -->

  <!-- Suspicious domain patterns - potential C2 (long random strings) -->
  <rule id="110010" level="12">
    <if_sid>110000</if_sid>
    <field name="QH" type="pcre2">^[a-z0-9]{20,}\.</field>
    <description>AdGuard: Suspicious long random domain - possible C2 - $(QH)</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>adguard_c2_suspect,threat_intel,</group>
  </rule>

  <!-- DNS tunneling detection - TXT queries -->
  <rule id="110011" level="6">
    <if_sid>110000</if_sid>
    <field name="QT">TXT</field>
    <description>AdGuard: TXT record query - monitor for DNS tunneling - $(QH)</description>
    <group>adguard_txt_query,</group>
  </rule>

  <!-- High frequency TXT queries (DNS exfiltration) -->
  <rule id="110012" level="14" frequency="20" timeframe="60">
    <if_matched_sid>110011</if_matched_sid>
    <same_field>IP</same_field>
    <description>AdGuard: High volume TXT queries from $(IP) - DNS exfiltration suspected</description>
    <mitre>
      <id>T1048.003</id>
    </mitre>
    <group>adguard_exfiltration,data_exfiltration,</group>
  </rule>

  <!-- Newly registered domain pattern (short random + suspicious TLD) -->
  <rule id="110013" level="8">
    <if_sid>110000</if_sid>
    <field name="QH" type="pcre2">^[a-z0-9]{5,12}\.(xyz|online|site|club|icu|top|work|click)$</field>
    <description>AdGuard: Suspicious newly-registered domain pattern - $(QH)</description>
    <mitre>
      <id>T1583.001</id>
    </mitre>
    <group>adguard_nrd_suspect,threat_intel,</group>
  </rule>

</group>

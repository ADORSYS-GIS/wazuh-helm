<!-- macOS Authentication & Authorization Rules -->
<!-- File 3 of 3: Authentication and authorization monitoring -->

<group name="macos,authentication,authorization">

    <!-- ============================================== -->
    <!-- USER LOGIN                                    -->
    <!-- ============================================== -->

    <rule id="600201" level="4">
        <if_group>authentication_success</if_group>
        <match>loginwindow|opendirectoryd|sshd</match>
        <description>macOS: Successful login</description>
        <group>authentication,pci_dss_10.2.5,nist_800_53_AU.14</group>
    </rule>

    <rule id="600202" level="7">
        <if_group>authentication_failed</if_group>
        <match>loginwindow|opendirectoryd|sshd</match>
        <description>macOS: Failed login attempt</description>
        <group>authentication,pci_dss_10.2.4,nist_800_53_AU.14</group>
    </rule>

    <rule id="600205" level="12" frequency="5" timeframe="300">
        <if_matched_sid>600202</if_matched_sid>
        <same_source_ip />
        <description>macOS: Multiple failed logins - brute force attempt</description>
        <group>authentication,brute_force,pci_dss_10.2.4,nist_800_53_AU.14</group>
    </rule>

    <!-- ============================================== -->
    <!-- SUDO AND PRIVILEGE ESCALATION                 -->
    <!-- ============================================== -->

    <rule id="600220" level="5">
        <if_group>syslog</if_group>
        <match>sudo</match>
        <regex>COMMAND|session opened</regex>
        <description>macOS: Sudo access/command execution</description>
        <group>privilege_escalation,pci_dss_10.2.5,nist_800_53_AU.14</group>
    </rule>

    <rule id="600221" level="12">
        <if_sid>600220</if_sid>
        <regex>USER=root|sudo.*root</regex>
        <description>macOS: Sudo escalation to root user</description>
        <group>privilege_escalation,pci_dss_10.2.5,nist_800_53_AU.14</group>
    </rule>

    <!-- ============================================== -->
    <!-- ANOMALIES                                     -->
    <!-- ============================================== -->

    <rule id="600250" level="8">
        <if_sid>600201</if_sid>
        <time>00:00-05:00</time>
        <description>macOS: Login during unusual hours (midnight to 5 AM)</description>
        <group>authentication,pci_dss_10.2.5,nist_800_53_AU.14</group>
    </rule>

</group>
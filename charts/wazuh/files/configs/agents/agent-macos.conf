<agent_config os="Darwin">
  <!-- ==================== -->
  <!-- macOS CONFIGURATION  -->
  <!-- ==================== -->

  <!-- Software Inventory (syscollector) - Required for blacklist detection -->
  <wodle name="syscollector">
    <disabled>no</disabled>
    <interval>1h</interval>
    <scan_on_start>yes</scan_on_start>
    <packages>yes</packages>
    <ports all="no">yes</ports>
    <processes>yes</processes>
    <hotfixes>yes</hotfixes>
    <network>yes</network>
    <synchronization>
      <max_eps>10</max_eps>
    </synchronization>
  </wodle>

  <!-- Security Configuration Assessment for macOS -->
  <sca>
    <enabled>yes</enabled>
    <scan_on_start>yes</scan_on_start>
    <interval>12h</interval>
    <skip_nfs>yes</skip_nfs>
  </sca>

  <!-- Automatic SCA Policy Sync Wodle -->
  <!-- Copies custom SCA policies from etc/shared to ruleset/sca -->
  <wodle name="command">
    <disabled>no</disabled>
    <tag>sca-policy-sync</tag>
    <command>/bin/bash /Library/Ossec/etc/shared/sync_sca_policies.sh</command>
    <interval>1h</interval>
    <ignore_output>no</ignore_output>
    <run_on_start>yes</run_on_start>
    <timeout>60</timeout>
  </wodle>

  <!-- File Integrity Monitoring -->
  <syscheck>
    <disabled>no</disabled>
    <frequency>43200</frequency>
    <scan_on_start>yes</scan_on_start>
    <alert_new_files>yes</alert_new_files>
    <auto_ignore frequency="10" timeframe="3600">no</auto_ignore>

    <!-- System binaries -->
    <directories check_all="yes">/usr/bin,/usr/sbin</directories>
    <directories check_all="yes">/bin,/sbin</directories>
    <directories check_all="yes">/usr/local/bin,/usr/local/sbin</directories>

    <!-- System configuration -->
    <directories check_all="yes">/etc</directories>
    <directories check_all="yes">/private/etc</directories>

    <!-- LaunchDaemons and LaunchAgents (persistence mechanisms) -->
    <directories realtime="yes" check_all="yes">/Library/LaunchDaemons</directories>
    <directories realtime="yes" check_all="yes">/Library/LaunchAgents</directories>
    <directories realtime="yes" check_all="yes">/System/Library/LaunchDaemons</directories>
    <directories realtime="yes" check_all="yes">/System/Library/LaunchAgents</directories>

    <!-- User LaunchAgents -->
    <directories realtime="yes" check_all="yes">/Users/*/Library/LaunchAgents</directories>

    <!-- Startup Items (legacy) -->
    <directories check_all="yes">/Library/StartupItems</directories>

    <!-- Cron jobs -->
    <directories realtime="yes" check_all="yes">/var/at/tabs</directories>
    <directories realtime="yes" check_all="yes">/etc/crontab</directories>
    <directories realtime="yes" check_all="yes">/usr/lib/cron/tabs</directories>

    <!-- Login/Logout hooks -->
    <directories realtime="yes" check_all="yes">/var/root/Library/Preferences/com.apple.loginwindow.plist</directories>

    <!-- Kernel extensions -->
    <directories check_all="yes">/Library/Extensions</directories>
    <directories check_all="yes">/System/Library/Extensions</directories>

    <!-- Authorization plugins -->
    <directories realtime="yes" check_all="yes">/Library/Security/SecurityAgentPlugins</directories>

    <!-- Periodic scripts -->
    <directories check_all="yes">/etc/periodic/daily</directories>
    <directories check_all="yes">/etc/periodic/weekly</directories>
    <directories check_all="yes">/etc/periodic/monthly</directories>

    <!-- SSH configuration -->
    <directories realtime="yes" check_all="yes">/etc/ssh</directories>
    <directories realtime="yes" check_all="yes">/Users/*/.ssh</directories>

    <!-- Sudoers -->
    <directories realtime="yes" check_all="yes">/etc/sudoers</directories>
    <directories realtime="yes" check_all="yes">/etc/sudoers.d</directories>
    <directories realtime="yes" check_all="yes">/private/etc/sudoers.d</directories>

    <!-- PAM configuration -->
    <directories realtime="yes" check_all="yes">/etc/pam.d</directories>

    <!-- Hosts file -->
    <directories realtime="yes" check_all="yes">/etc/hosts</directories>
    <directories realtime="yes" check_all="yes">/private/etc/hosts</directories>

    <!-- Application support (for malware persistence) -->
    <directories check_all="yes">/Library/Application Support</directories>

    <!-- Standard ignores -->
    <ignore>/etc/mtab</ignore>
    <ignore>/etc/hosts.deny</ignore>
    <ignore>/etc/mail/statistics</ignore>
    <ignore>/etc/random-seed</ignore>
    <ignore>/etc/adjtime</ignore>
    <ignore>/etc/cups/certs</ignore>
    <ignore type="sregex">.log$|.swp$|.tmp$|.DS_Store$</ignore>

    <!-- macOS SIP-protected directories (cannot be monitored) -->
    <ignore>/Library/Application Support/com.apple.TCC</ignore>

    <!-- Sensitive files - no diff -->
    <nodiff>/etc/ssl/private.key</nodiff>
    <nodiff>/etc/master.passwd</nodiff>
    <nodiff>/var/db/shadow/hash/*</nodiff>

    <skip_nfs>yes</skip_nfs>
    <skip_dev>yes</skip_dev>
    <skip_proc>yes</skip_proc>
    <skip_sys>yes</skip_sys>
    <max_eps>100</max_eps>
  </syscheck>

  <!-- Log Collection - macOS Unified Logging -->
  <localfile>
    <location>macos</location>
    <log_format>macos</log_format>
    <query type="log,trace" level="info">process == "sudo" OR process == "sshd" OR process == "login"</query>
  </localfile>

  <localfile>
    <location>macos</location>
    <log_format>macos</log_format>
    <query type="log,trace" level="info">process == "screensharingd" OR process == "ARDAgent"</query>
  </localfile>

  <localfile>
    <location>macos</location>
    <log_format>macos</log_format>
    <query type="activity,log,trace" level="info">eventMessage CONTAINS "authentication" OR eventMessage CONTAINS "failed"</query>
  </localfile>

  <!-- Suricata IDS/IPS Integration (Apple Silicon Macs) -->
  <!-- Suricata provides DNS logging, threat detection, and network monitoring -->
  <localfile>
    <log_format>json</log_format>
    <location>/opt/homebrew/var/log/suricata/eve.json</location>
  </localfile>

  <!-- System log files -->
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/system.log</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/secure.log</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/install.log</location>
  </localfile>

  <!-- Commands for macOS -->
  <localfile>
    <log_format>command</log_format>
    <command>df -P</command>
    <frequency>360</frequency>
  </localfile>

  <localfile>
    <log_format>full_command</log_format>
    <command>netstat -an | grep LISTEN</command>
    <alias>netstat listening ports</alias>
    <frequency>360</frequency>
  </localfile>

  <localfile>
    <log_format>full_command</log_format>
    <command>last -20</command>
    <frequency>360</frequency>
  </localfile>

  <!-- Real-time process monitoring for blacklist detection -->
  <!-- Checks for unauthorized applications every 60 seconds -->
  <localfile>
    <log_format>full_command</log_format>
    <command>ps aux | grep -iE 'wireshark|tshark|nmap|teamviewer|anydesk|rustdesk|xmrig|nicehash|utorrent|bittorrent|qbittorrent|transmission|deluge|nordvpn|expressvpn|protonvpn|steam|epicgames' | grep -v grep</command>
    <alias>blacklist_process_check</alias>
    <frequency>60</frequency>
  </localfile>

  <!-- OpenBSM Audit Logs (macOS native audit) -->
  <localfile>
    <log_format>audit</log_format>
    <location>/var/audit/current</location>
  </localfile>
</agent_config>

# =============================================================================
# WAZUH HELM CHART - MULTI-TENANCY VALUES
# =============================================================================
# This values file provides country-based multi-tenancy configuration.
#
# Usage:
#   helm install wazuh ./charts/wazuh \
#     -f charts/wazuh/values.yaml \
#     -f charts/wazuh/values-multitenancy.yaml
#
# Or with Keycloak:
#   helm install wazuh ./charts/wazuh \
#     -f charts/wazuh/values.yaml \
#     -f charts/wazuh/values-multitenancy.yaml \
#     --set indexer.keycloak.enabled=true \
#     --set indexer.keycloak.client_id=wazuh \
#     --set indexer.keycloak.client_secret=<secret> \
#     --set indexer.keycloak.openid_connect_url=https://<keycloak>/realms/<realm>/.well-known/openid-configuration
#
# Tenants:
#   - CM: Cameroon team
#   - DE: Germany team
#   - EXT: External actors (auditors, consultants)
#
# Authentication Options:
#   1. OpenSearch Native Auth (default) - Uses internal users defined below
#   2. Keycloak/OIDC - Uses external identity provider with role mapping
#
# For Keycloak setup, see: docs/authentication/keycloak-setup.md
# =============================================================================

indexer:
  # =============================================================================
  # MULTI-TENANCY CONFIGURATION
  # =============================================================================
  multiTenancy:
    enabled: true

    # -------------------------------------------------------------------------
    # TENANT DEFINITIONS
    # -------------------------------------------------------------------------
    # Each tenant provides isolated dashboard space for a country/team.
    # Users can only access tenants they have permissions for.
    tenants:
      cm_tenant:
        description: "Tenant for Cameroon team"
      de_tenant:
        description: "Tenant for Germany team"
      ext_tenant:
        description: "Tenant for External actors (auditors)"

    # -------------------------------------------------------------------------
    # INTERNAL USERS (OpenSearch Native Authentication)
    # -------------------------------------------------------------------------
    # These users are created when NOT using Keycloak.
    # For production, change passwords and store in external secrets.
    #
    # To use external secrets instead:
    #   1. Create a Kubernetes secret with user credentials
    #   2. Set internalUsersSecret: <secret-name>
    # -------------------------------------------------------------------------
    internalUsers:
      # ----- CAMEROON -----
      cm_admin:
        enabled: true
        password: "CM_Admin_Ch@ng3M3!"      # CHANGE IN PRODUCTION
        backendRoles:
          - "wazuh_cm_admin"
        description: "Cameroon country administrator"

      cm_user:
        enabled: true                        # Enable for read-only users
        password: "CM_User_Ch@ng3M3!"
        backendRoles:
          - "wazuh_cm_user"
        description: "Cameroon read-only user"

      # ----- GERMANY -----
      de_admin:
        enabled: true
        password: "DE_Admin_Ch@ng3M3!"      # CHANGE IN PRODUCTION
        backendRoles:
          - "wazuh_de_admin"
        description: "Germany country administrator"

      de_user:
        enabled: true
        password: "DE_User_Ch@ng3M3!"
        backendRoles:
          - "wazuh_de_user"
        description: "Germany read-only user"

      # ----- EXTERNAL (AUDITORS) -----
      ext_admin:
        enabled: true
        password: "EXT_Admin_Ch@ng3M3!"     # CHANGE IN PRODUCTION
        backendRoles:
          - "wazuh_ext_admin"
        description: "External actors administrator (auditors)"

      ext_user:
        enabled: true
        password: "EXT_User_Ch@ng3M3!"
        backendRoles:
          - "wazuh_ext_user"
        description: "External read-only user"

    # -------------------------------------------------------------------------
    # AGENT GROUPS
    # -------------------------------------------------------------------------
    # Define Wazuh agent groups that will be created automatically.
    # Agents assigned to these groups will only be visible to users with
    # matching tenant access (via Document-Level Security).
    # -------------------------------------------------------------------------
    agentGroups:
      - name: "CM"
        description: "Cameroon agents"
      - name: "DE"
        description: "Germany agents"
      - name: "EXT"
        description: "External agents"

    # -------------------------------------------------------------------------
    # ROLE DEFINITIONS
    # -------------------------------------------------------------------------
    # Roles define permissions for indices and tenants.
    # Each country has:
    #   - Admin role: Full read/write access to security data within their tenant
    #   - User role: Read-only access to security data within their tenant
    #
    # IMPORTANT: Document-Level Security (DLS) filters alerts by agent.group
    # so users only see data from agents in their assigned group.
    #
    # Required permissions for Wazuh Dashboard access:
    #   - cluster_monitor: View cluster health
    #   - Wazuh indices: wazuh-alerts-*, wazuh-archives-*, wazuh-monitoring-*, wazuh-statistics-*
    #   - Wazuh config: .wazuh, .wazuh-version
    #   - Dashboard: .kibana*, .opensearch_dashboards*
    # -------------------------------------------------------------------------
    roles:
      # ===== CAMEROON ROLES =====
      # Admin: Full access to CM agents data, can manage dashboards in cm_tenant
      wazuh_cm_admin:
        reserved: false
        cluster_permissions:
          - "cluster_monitor"
          - "cluster_composite_ops"
          - "cluster:admin/opendistro/reports/*"
          - "cluster:admin/opendistro/alerting/*"
          - "indices:admin/template/*"
          - "indices:data/read/scroll*"
        index_permissions:
          # Wazuh data indices - DLS filters to CM group only
          - index_patterns:
              - "wazuh-alerts-*"
              - "wazuh-archives-*"
            dls: '{"bool":{"should":[{"match":{"agent.groups":"CM"}},{"bool":{"must_not":{"exists":{"field":"agent.groups"}}}}]}}'
            allowed_actions:
              - "read"
              - "search"
              - "get"
          # Monitoring - filter by group
          - index_patterns:
              - "wazuh-monitoring-*"
            dls: '{"bool":{"should":[{"match":{"group":"CM"}},{"bool":{"must_not":{"exists":{"field":"group"}}}}]}}'
            allowed_actions:
              - "read"
              - "search"
              - "get"
          # Statistics - no DLS needed (aggregate data)
          - index_patterns:
              - "wazuh-statistics-*"
            allowed_actions:
              - "read"
              - "search"
              - "get"
          # Wazuh app configuration
          - index_patterns:
              - ".wazuh"
              - ".wazuh-version"
            allowed_actions:
              - "read"
              - "search"
              - "get"
          # Dashboard saved objects - full access for admin in their tenant
          - index_patterns:
              - ".kibana*"
              - ".opensearch_dashboards*"
            allowed_actions:
              - "read"
              - "write"
              - "delete"
              - "manage"
              - "indices_all"
        tenant_permissions:
          - tenant_patterns:
              - "cm_tenant"
            allowed_actions:
              - "kibana_all_write"

      # User: Read-only access to CM agents data
      wazuh_cm_user:
        reserved: false
        cluster_permissions:
          - "cluster_monitor"
          - "cluster_composite_ops_ro"
          - "indices:data/read/scroll*"
        index_permissions:
          # Wazuh data indices - DLS filters to CM group only
          - index_patterns:
              - "wazuh-alerts-*"
              - "wazuh-archives-*"
            dls: '{"bool":{"should":[{"match":{"agent.groups":"CM"}},{"bool":{"must_not":{"exists":{"field":"agent.groups"}}}}]}}'
            allowed_actions:
              - "read"
              - "search"
              - "get"
          - index_patterns:
              - "wazuh-monitoring-*"
            dls: '{"bool":{"should":[{"match":{"group":"CM"}},{"bool":{"must_not":{"exists":{"field":"group"}}}}]}}'
            allowed_actions:
              - "read"
              - "search"
              - "get"
          - index_patterns:
              - "wazuh-statistics-*"
            allowed_actions:
              - "read"
              - "search"
              - "get"
          - index_patterns:
              - ".wazuh"
              - ".wazuh-version"
            allowed_actions:
              - "read"
              - "search"
              - "get"
          # Dashboard - read only, no write/delete
          - index_patterns:
              - ".kibana*"
              - ".opensearch_dashboards*"
            allowed_actions:
              - "read"
              - "search"
              - "get"
        tenant_permissions:
          - tenant_patterns:
              - "cm_tenant"
            allowed_actions:
              - "kibana_all_read"

      # ===== GERMANY ROLES =====
      # Admin: Full access to DE agents data, can manage dashboards in de_tenant
      wazuh_de_admin:
        reserved: false
        cluster_permissions:
          - "cluster_monitor"
          - "cluster_composite_ops"
          - "cluster:admin/opendistro/reports/*"
          - "cluster:admin/opendistro/alerting/*"
          - "indices:admin/template/*"
          - "indices:data/read/scroll*"
        index_permissions:
          # Wazuh data indices - DLS filters to DE group only
          - index_patterns:
              - "wazuh-alerts-*"
              - "wazuh-archives-*"
            dls: '{"bool":{"should":[{"match":{"agent.groups":"DE"}},{"bool":{"must_not":{"exists":{"field":"agent.groups"}}}}]}}'
            allowed_actions:
              - "read"
              - "search"
              - "get"
          - index_patterns:
              - "wazuh-monitoring-*"
            dls: '{"bool":{"should":[{"match":{"group":"DE"}},{"bool":{"must_not":{"exists":{"field":"group"}}}}]}}'
            allowed_actions:
              - "read"
              - "search"
              - "get"
          - index_patterns:
              - "wazuh-statistics-*"
            allowed_actions:
              - "read"
              - "search"
              - "get"
          - index_patterns:
              - ".wazuh"
              - ".wazuh-version"
            allowed_actions:
              - "read"
              - "search"
              - "get"
          # Dashboard saved objects - full access for admin in their tenant
          - index_patterns:
              - ".kibana*"
              - ".opensearch_dashboards*"
            allowed_actions:
              - "read"
              - "write"
              - "delete"
              - "manage"
              - "indices_all"
        tenant_permissions:
          - tenant_patterns:
              - "de_tenant"
            allowed_actions:
              - "kibana_all_write"

      # User: Read-only access to DE agents data (NO delete permissions)
      wazuh_de_user:
        reserved: false
        cluster_permissions:
          - "cluster_monitor"
          - "cluster_composite_ops_ro"
          - "indices:data/read/scroll*"
        index_permissions:
          # Wazuh data indices - DLS filters to DE group only
          - index_patterns:
              - "wazuh-alerts-*"
              - "wazuh-archives-*"
            dls: '{"bool":{"should":[{"match":{"agent.groups":"DE"}},{"bool":{"must_not":{"exists":{"field":"agent.groups"}}}}]}}'
            allowed_actions:
              - "read"
              - "search"
              - "get"
          - index_patterns:
              - "wazuh-monitoring-*"
            dls: '{"bool":{"should":[{"match":{"group":"DE"}},{"bool":{"must_not":{"exists":{"field":"group"}}}}]}}'
            allowed_actions:
              - "read"
              - "search"
              - "get"
          - index_patterns:
              - "wazuh-statistics-*"
            allowed_actions:
              - "read"
              - "search"
              - "get"
          - index_patterns:
              - ".wazuh"
              - ".wazuh-version"
            allowed_actions:
              - "read"
              - "search"
              - "get"
          # Dashboard - read only, NO write/delete
          - index_patterns:
              - ".kibana*"
              - ".opensearch_dashboards*"
            allowed_actions:
              - "read"
              - "search"
              - "get"
        tenant_permissions:
          - tenant_patterns:
              - "de_tenant"
            allowed_actions:
              - "kibana_all_read"

      # ===== EXTERNAL ROLES (AUDITORS) =====
      # Admin: Full access to EXT agents data, can manage dashboards in ext_tenant
      wazuh_ext_admin:
        reserved: false
        cluster_permissions:
          - "cluster_monitor"
          - "cluster_composite_ops"
          - "cluster:admin/opendistro/reports/*"
          - "cluster:admin/opendistro/alerting/*"
          - "indices:admin/template/*"
          - "indices:data/read/scroll*"
        index_permissions:
          # Wazuh data indices - DLS filters to EXT group only
          - index_patterns:
              - "wazuh-alerts-*"
              - "wazuh-archives-*"
            dls: '{"bool":{"should":[{"match":{"agent.groups":"EXT"}},{"bool":{"must_not":{"exists":{"field":"agent.groups"}}}}]}}'
            allowed_actions:
              - "read"
              - "search"
              - "get"
          - index_patterns:
              - "wazuh-monitoring-*"
            dls: '{"bool":{"should":[{"match":{"group":"EXT"}},{"bool":{"must_not":{"exists":{"field":"group"}}}}]}}'
            allowed_actions:
              - "read"
              - "search"
              - "get"
          - index_patterns:
              - "wazuh-statistics-*"
            allowed_actions:
              - "read"
              - "search"
              - "get"
          - index_patterns:
              - ".wazuh"
              - ".wazuh-version"
            allowed_actions:
              - "read"
              - "search"
              - "get"
          # Dashboard saved objects - full access for admin in their tenant
          - index_patterns:
              - ".kibana*"
              - ".opensearch_dashboards*"
            allowed_actions:
              - "read"
              - "write"
              - "delete"
              - "manage"
              - "indices_all"
        tenant_permissions:
          - tenant_patterns:
              - "ext_tenant"
            allowed_actions:
              - "kibana_all_write"

      # User: Read-only access to EXT agents data (NO delete permissions)
      wazuh_ext_user:
        reserved: false
        cluster_permissions:
          - "cluster_monitor"
          - "cluster_composite_ops_ro"
          - "indices:data/read/scroll*"
        index_permissions:
          # Wazuh data indices - DLS filters to EXT group only
          - index_patterns:
              - "wazuh-alerts-*"
              - "wazuh-archives-*"
            dls: '{"bool":{"should":[{"match":{"agent.groups":"EXT"}},{"bool":{"must_not":{"exists":{"field":"agent.groups"}}}}]}}'
            allowed_actions:
              - "read"
              - "search"
              - "get"
          - index_patterns:
              - "wazuh-monitoring-*"
            dls: '{"bool":{"should":[{"match":{"group":"EXT"}},{"bool":{"must_not":{"exists":{"field":"group"}}}}]}}'
            allowed_actions:
              - "read"
              - "search"
              - "get"
          - index_patterns:
              - "wazuh-statistics-*"
            allowed_actions:
              - "read"
              - "search"
              - "get"
          - index_patterns:
              - ".wazuh"
              - ".wazuh-version"
            allowed_actions:
              - "read"
              - "search"
              - "get"
          # Dashboard - read only, NO write/delete
          - index_patterns:
              - ".kibana*"
              - ".opensearch_dashboards*"
            allowed_actions:
              - "read"
              - "search"
              - "get"
        tenant_permissions:
          - tenant_patterns:
              - "ext_tenant"
            allowed_actions:
              - "kibana_all_read"

    # -------------------------------------------------------------------------
    # ROLE MAPPINGS
    # -------------------------------------------------------------------------
    # Maps backend roles (from Keycloak or internal users) to OpenSearch roles.
    #
    # For Keycloak: Users receive backend_roles from the OIDC token's roles claim
    # For Internal Auth: Users receive backend_roles defined in internalUsers above
    # -------------------------------------------------------------------------
    rolesMapping:
      # Cameroon mappings
      wazuh_cm_admin:
        backend_roles:
          - "wazuh_cm_admin"
        users:
          - "cm_admin"

      wazuh_cm_user:
        backend_roles:
          - "wazuh_cm_user"
        users:
          - "cm_user"

      # Germany mappings
      wazuh_de_admin:
        backend_roles:
          - "wazuh_de_admin"
        users:
          - "de_admin"

      wazuh_de_user:
        backend_roles:
          - "wazuh_de_user"
        users:
          - "de_user"

      # External mappings
      wazuh_ext_admin:
        backend_roles:
          - "wazuh_ext_admin"
        users:
          - "ext_admin"

      wazuh_ext_user:
        backend_roles:
          - "wazuh_ext_user"
        users:
          - "ext_user"

  # Enable security admin job to apply the configuration
  securityAdmin:
    enabled: true
    maxRetries: 30
    retryInterval: 10

# =============================================================================
# DASHBOARD CONFIGURATION
# =============================================================================
# Configure preferred tenants for the dashboard
dashboard:
  # Multi-tenancy is already enabled by default in the chart
  # This just adjusts the preferred tenant order
  multiTenancy:
    preferredTenants:
      - "Global"       # System-wide dashboards
      - "cm_tenant"    # Cameroon
      - "de_tenant"    # Germany
      - "ext_tenant"   # External
      - "Private"      # Personal dashboards


# =============================================================================
# KEYCLOAK GROUP-TO-TENANT MAPPING REFERENCE
# =============================================================================
# This section is documentation only - actual Keycloak configuration must be
# done in Keycloak Admin Console. See docs/authentication/keycloak-setup.md
#
# GROUPS TO CREATE IN KEYCLOAK:
# =============================
#
# | Keycloak Group      | Keycloak Role      | OpenSearch Role    | Tenant Access      |
# |---------------------|--------------------|--------------------|-------------------|
# | wazuh-cm-admins     | wazuh_cm_admin     | wazuh_cm_admin     | cm_tenant (RW)    |
# | wazuh-cm-users      | wazuh_cm_user      | wazuh_cm_user      | cm_tenant (RO)    |
# | wazuh-de-admins     | wazuh_de_admin     | wazuh_de_admin     | de_tenant (RW)    |
# | wazuh-de-users      | wazuh_de_user      | wazuh_de_user      | de_tenant (RO)    |
# | wazuh-ext-admins    | wazuh_ext_admin    | wazuh_ext_admin    | ext_tenant (RW)   |
# | wazuh-ext-users     | wazuh_ext_user     | wazuh_ext_user     | ext_tenant (RO)   |
#
# FLOW:
# =====
# 1. Create Keycloak groups (above)
# 2. Assign Keycloak roles to groups
# 3. Add users to groups
# 4. User logs in → Gets roles via OIDC token → OpenSearch maps to tenant
#
# KEYCLOAK ROLES TO CREATE:
# =========================
# - wazuh_cm_admin
# - wazuh_cm_user
# - wazuh_de_admin
# - wazuh_de_user
# - wazuh_ext_admin
# - wazuh_ext_user
#
# These roles must match the backend_roles in rolesMapping above.
# =============================================================================

{{ with .Values.dashboard }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "common.names.fullname" $ }}-dashboard
  annotations:
    {{- include "common.annotations.standard" ( dict "customAnnotations" .additionalAnnotations "context" $ ) | nindent 4 }}
  labels:
    {{ include "common.labels.standard" ( dict "customLabels" .additionalLabels "context" $ ) | nindent 4 }}
    app: {{ include "common.names.fullname" $ }}-dashboard
spec:
  replicas: 1
  selector:
    matchLabels:
      {{ include "common.labels.matchLabels" ( dict "customLabels" .additionalLabels "context" $ ) | nindent 6 }}
      app: {{ include "common.names.fullname" $ }}-dashboard
  template:
    metadata:
      annotations:
        {{- include "common.annotations.standard" ( dict "customAnnotations" .additionalAnnotations "context" $ ) | nindent 8 }}
        checksum/config: {{ include (print $.Template.BasePath "/dashboard/configmap.yaml") $ | sha256sum }}
        {{ with $.Values.dashboard.auth -}}
        checksum/secret: {{ include (print $.Template.BasePath "/dashboard/secret.yaml") $ | sha256sum }}
        {{- end }}
        {{ with $.Values.indexer.auth -}}
        checksum/secret.indexer: {{ include (print $.Template.BasePath "/indexer/secret.yaml") $ | sha256sum }}
        {{- end }}
      labels:
        {{ include "common.labels.standard" ( dict "customLabels" .additionalLabels "context" $ ) | nindent 8 }}
        app: {{ include "common.names.fullname" $ }}-dashboard
      name: {{ include "common.names.fullname" $ }}-dashboard
    spec:
      volumes:
      - name: certs
        secret:
          secretName: {{ include "wazuh.cert_secret_name" $ }}
      - name: root-certs
        secret:
          secretName: {{ include "wazuh.cert_root_name" $ }}
      - name: config
        configMap:
          name: '{{ include "common.names.fullname" $ }}-dashboard-conf'
      {{ with .volumes }}
      {{ include "common.tplvalues.render" (dict "value" . "context" $) | nindent 6}}
      {{ end }}
      {{ if .customization.enabled }}
      - name: branding-config
        configMap:
          name: '{{ include "common.names.fullname" $ }}-dashboard-branding-conf'
          items:
            - key: branding.wazuh.yml
              path: branding.wazuh.yml
      - name: branding-assets
        emptyDir: {}
      {{ end }}
      {{ if .customization.enabled }}
      initContainers:
        - name: branding-init
          image: curlimages/curl:latest
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsUser: 0
          command:
            - sh
            - -c
            - |
              set -e

              # Download logos
              mkdir -p /branding/images
              curl -Lo /branding/images/customization.logo.healthcheck.svg {{ $.Values.dashboard.customization.healthCheckLogo }}
              curl -Lo /branding/images/customization.logo.reports.png {{ $.Values.dashboard.customization.reportLogo }}
          volumeMounts:
            - name: branding-assets
              mountPath: /branding/images
      {{- end }}
      containers:
        - name: wazuh-dashboard
          {{ $imageTpl := include "common.images.image" (dict "imageRoot" .image "global" $.Values.global) }}
          image: {{ include "common.tplvalues.render" (dict "value" $imageTpl "context" $) | quote }}
          {{ with .resources -}}
          resources:
          {{ include "common.tplvalues.render" (dict "value" . "context" $) | nindent 12 }}
          {{- end }}
          {{ if .customization.enabled }}
          lifecycle:
            postStart:
              exec:
                command:
                  - sh
                  - -c
                  - |
                    set -e

                    for i in {1..120}; do
                      if [ -f /usr/share/wazuh-dashboard/data/wazuh/config/wazuh.yml ]; then
                        if [ -f /tmp/branding/branding.wazuh.yml ]; then
                          echo "Attempt $i: Appending branding config to wazuh.yml" >&2
                          cat /tmp/branding/branding.wazuh.yml >> /usr/share/wazuh-dashboard/data/wazuh/config/wazuh.yml
                          exit 0
                        else
                          echo "Attempt $i: Branding config file not found, skipping append" >&2
                          rm -rf /tmp/branding
                          exit 0
                        fi
                      fi
                      sleep 1
                    done
                    echo "Timeout waiting for wazuh.yml" >&2
                    rm -rf /tmp/branding
                    exit 1
          {{- end }}
          volumeMounts:
          - name: root-certs
            mountPath: /usr/share/wazuh-dashboard/certs/root-ca.pem
            subPath: root-ca.pem
            readOnly: true
          - name: certs
            mountPath: /usr/share/wazuh-dashboard/certs/dashboard-key.pem
            readOnly: true
            subPath: dashboard-key.pem
          - name: certs
            mountPath: /usr/share/wazuh-dashboard/certs/dashboard.pem
            readOnly: true
            subPath: dashboard.pem
          - name: config
            mountPath: /usr/share/wazuh-dashboard/config/opensearch_dashboards.yml
            subPath: opensearch_dashboards.yml
            readOnly: false
          {{ if .customization.enabled }}
          - name: branding-assets
            mountPath: /usr/share/wazuh-dashboard/plugins/wazuh/public/assets/custom/images
            readOnly: true
          - name: branding-config
            mountPath: /tmp/branding
            readOnly: true
          {{- end }}
          {{ with .volumeMounts -}}
          {{ include "common.tplvalues.render" (dict "value" . "context" $) | nindent 10}}
          {{- end }}
          {{ with .ports -}}
          ports: {{ include "common.tplvalues.render" (dict "value" . "context" $) | nindent 12}}
          {{- end }}
          env:
            - name: INDEXER_URL
              value: 'https://{{ include "common.names.fullname" $ }}-indexer-api:9200'
            - name: WAZUH_API_URL
              value: 'https://{{ include "common.names.fullname" $ }}'
            - name: SERVER_SSL_ENABLED
              value: "true"
            - name: SERVER_SSL_CERTIFICATE
              value: /usr/share/wazuh-dashboard/certs/dashboard.pem
            - name: SERVER_SSL_KEY
              value: /usr/share/wazuh-dashboard/certs/dashboard-key.pem
          {{ with .env -}}
          {{ include "common.tplvalues.render" (dict "value" . "context" $) | nindent 12}}
          {{- end }}
          envFrom:
            - secretRef:
                name: '{{ include "secret.indexer-auth" $ }}'
            - secretRef:
                name: '{{ include "secret.api-auth" $ }}'
            - secretRef:
                name: '{{ include "secret.dashboard-auth" $ }}'
          {{ with .envFrom -}}
          {{ include "common.tplvalues.render" (dict "value" . "context" $) | nindent 12}}
          {{- end }}
{{ end }}
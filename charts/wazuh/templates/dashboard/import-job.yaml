{{- if .Values.dashboard.importSavedObjects.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "common.names.fullname" $ }}-import-saved-objects
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation
    {{- include "common.annotations.standard" ( dict "customAnnotations" $.Values.commonAnnotations "context" $ ) | nindent 4 }}
  labels:
    {{- include "common.labels.standard" ( dict "customLabels" $.Values.commonLabels "context" $ ) | nindent 4 }}
    app: {{ include "common.names.fullname" $ }}-import-saved-objects
spec:
  backoffLimit: 3
  template:
    metadata:
      annotations:
        {{- include "common.annotations.standard" ( dict "customAnnotations" $.Values.commonAnnotations "context" $ ) | nindent 8 }}
      labels:
        {{- include "common.labels.standard" ( dict "customLabels" $.Values.commonLabels "context" $ ) | nindent 8 }}
        app: {{ include "common.names.fullname" $ }}-import-saved-objects
    spec:
      restartPolicy: OnFailure
      volumes:
        - name: export-data
          configMap:
            name: {{ include "common.names.fullname" $ }}-dashboard-export
      initContainers:
        - name: wait-for-dashboard
          image: curlimages/curl:8.17.0
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              #!/bin/bash
              set -e
              
              # Wait for dashboard to be ready with better error handling
              echo "Waiting for Wazuh Dashboard to be ready..."
              retries=60
              until curl -k -u "${DASHBOARD_USERNAME}:${DASHBOARD_PASSWORD}" \
                "https://{{ include "common.names.fullname" $ }}-dashboard:5601/api/status" >/dev/null 2>&1; do
                echo "Still waiting for Wazuh Dashboard to be ready..."
                sleep 10
                retries=$((retries - 1))
                if [ $retries -le 0 ]; then
                  echo "Timeout waiting for dashboard to be ready"
                  exit 1
                fi
              done
              
              # Give it a bit more time to fully initialize
              sleep 10
              echo "Wazuh Dashboard is ready!"
          env:
            - name: DASHBOARD_USERNAME
              valueFrom:
                secretKeyRef:
                  name: '{{ include "secret.dashboard-auth" $ }}'
                  key: DASHBOARD_USERNAME
            - name: DASHBOARD_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: '{{ include "secret.dashboard-auth" $ }}'
                  key: DASHBOARD_PASSWORD
      containers:
        - name: import-saved-objects
          image: curlimages/curl:8.17.0
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              #!/bin/bash
              set -e
              
              # Copy all export files to a writable location
              mkdir -p /tmp/wazuh-import
              
              # Import each export file
              for export_file in /tmp/export-files/*.ndjson; do
                if [ -f "$export_file" ]; then
                  filename=$(basename "$export_file")
                  echo "Processing export file: $filename"
                  
                  # Copy to writable location
                  cp "$export_file" "/tmp/wazuh-import/$filename"
                  chmod 644 "/tmp/wazuh-import/$filename"
                  
                  # Import saved objects with better error handling
                  echo "Importing saved objects from $filename..."
                  response=$(curl -k -u "${DASHBOARD_USERNAME}:${DASHBOARD_PASSWORD}" \
                    -H "osd-xsrf: true" \
                    -F file=@"/tmp/wazuh-import/$filename" \
                    -X POST "https://{{ include "common.names.fullname" $ }}-dashboard:5601/api/saved_objects/_import?createNewCopies=true" \
                    -w "%{http_code}" -o "/tmp/import-response-$filename.txt")
                  
                  echo "Import response status for $filename: $response"
                  echo "Import response body for $filename:"
                  cat "/tmp/import-response-$filename.txt"
                  
                  if [ "$response" -eq 200 ] || [ "$response" -eq 409 ]; then
                    echo "Import of $filename completed successfully or objects already exist"
                  else
                    echo "Import of $filename failed with status $response"
                    cat "/tmp/import-response-$filename.txt"
                    exit 1
                  fi
                fi
              done
              
              echo "All export files processed"
          volumeMounts:
            - name: export-data
              mountPath: /tmp/export-files
          env:
            - name: DASHBOARD_USERNAME
              valueFrom:
                secretKeyRef:
                  name: '{{ include "secret.dashboard-auth" $ }}'
                  key: DASHBOARD_USERNAME
            - name: DASHBOARD_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: '{{ include "secret.dashboard-auth" $ }}'
                  key: DASHBOARD_PASSWORD
{{- end }}

{{- if and .Values.indexer.multiTenancy .Values.indexer.multiTenancy.enabled .Values.indexer.multiTenancy.agentGroups }}
{{- $agentGroups := .Values.indexer.multiTenancy.agentGroups }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "common.names.fullname" $ }}-agent-groups
  namespace: {{ include "common.names.namespace" $ }}
  annotations:
    {{- include "common.annotations.standard" ( dict "customAnnotations" .Values.commonAnnotations "context" $ ) | nindent 4 }}
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "20"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  labels:
    {{- include "common.labels.standard" ( dict "customLabels" .Values.commonLabels "context" $ ) | nindent 4 }}
    app.kubernetes.io/component: agent-groups-setup
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        {{- include "common.labels.standard" ( dict "customLabels" .Values.commonLabels "context" $ ) | nindent 8 }}
        app.kubernetes.io/component: agent-groups-setup
    spec:
      restartPolicy: OnFailure
      containers:
        - name: agent-groups-setup
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |
              set -e

              WAZUH_API_URL="https://{{ include "common.names.fullname" $ }}:55000"
              MAX_RETRIES=60
              RETRY_INTERVAL=5

              echo "==========================================="
              echo "Wazuh Agent Groups Setup"
              echo "==========================================="
              echo ""

              # Wait for Wazuh Manager API to be ready
              echo "Waiting for Wazuh Manager API to be ready..."
              for i in $(seq 1 $MAX_RETRIES); do
                # Try to authenticate and get a token
                RESPONSE=$(curl -ks -X POST "${WAZUH_API_URL}/security/user/authenticate" \
                  -u "${API_USERNAME}:${API_PASSWORD}" \
                  -H "Content-Type: application/json" 2>&1) || true

                if echo "$RESPONSE" | grep -q '"token"'; then
                  echo "Wazuh Manager API is ready!"
                  break
                fi

                if [ $i -eq $MAX_RETRIES ]; then
                  echo "ERROR: Wazuh Manager API not ready after $MAX_RETRIES attempts"
                  echo "Last response: $RESPONSE"
                  exit 1
                fi

                echo "Attempt $i/$MAX_RETRIES: Wazuh Manager API not ready, waiting ${RETRY_INTERVAL}s..."
                sleep $RETRY_INTERVAL
              done

              # Get authentication token
              echo ""
              echo "Authenticating with Wazuh Manager API..."
              AUTH_RESPONSE=$(curl -ks -X POST "${WAZUH_API_URL}/security/user/authenticate" \
                -u "${API_USERNAME}:${API_PASSWORD}" \
                -H "Content-Type: application/json")

              # Extract token using shell parameter expansion (works with busybox)
              TOKEN="${AUTH_RESPONSE#*\"token\": \"}"
              TOKEN="${TOKEN%%\"*}"

              if [ -z "$TOKEN" ] || [ ${#TOKEN} -lt 100 ]; then
                echo "ERROR: Failed to obtain authentication token"
                echo "Response was: $AUTH_RESPONSE"
                exit 1
              fi
              echo "Authentication successful! (token length: ${#TOKEN})"

              # Function to create agent group
              create_agent_group() {
                local group_name="$1"

                echo "Creating agent group: $group_name"

                RESPONSE=$(curl -ks -X POST "${WAZUH_API_URL}/groups" \
                  -H "Authorization: Bearer ${TOKEN}" \
                  -H "Content-Type: application/json" \
                  -d "{\"group_id\": \"${group_name}\"}")

                # Check if group was created or already exists
                if echo "$RESPONSE" | grep -qE '"error":0|"title":"Resource already exists"'; then
                  echo "  âœ“ Group '$group_name' ready"
                else
                  echo "  Warning: Unexpected response for group '$group_name': $RESPONSE"
                fi
              }

              echo ""
              echo "Creating agent groups..."
              echo "-------------------------------------------"

              # Create each agent group
              {{- range $group := $agentGroups }}
              create_agent_group "{{ $group.name }}"
              {{- end }}

              echo ""
              echo "-------------------------------------------"
              echo "Verifying agent groups..."

              # List all groups to verify
              GROUPS=$(curl -ks -X GET "${WAZUH_API_URL}/groups" \
                -H "Authorization: Bearer ${TOKEN}" \
                -H "Content-Type: application/json")

              echo "Current agent groups:"
              echo "$GROUPS" | grep -o '"name":"[^"]*"' | cut -d'"' -f4 | while read -r name; do
                echo "  - $name"
              done

              echo ""
              echo "==========================================="
              echo "Agent groups setup complete!"
              echo "==========================================="
              echo ""
              echo "Groups configured:"
              {{- range $group := $agentGroups }}
              echo "  - {{ $group.name }}: {{ $group.description }}"
              {{- end }}
              echo ""
              echo "To assign an agent to a group, use:"
              echo "  /var/ossec/bin/agent_groups -a -i <agent_id> -g <group_name>"
              echo ""
          env:
            - name: API_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ include "secret.api-auth" $ }}
                  key: API_USERNAME
            - name: API_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "secret.api-auth" $ }}
                  key: API_PASSWORD
          resources:
            limits:
              cpu: 200m
              memory: 256Mi
            requests:
              cpu: 100m
              memory: 128Mi
{{- end }}

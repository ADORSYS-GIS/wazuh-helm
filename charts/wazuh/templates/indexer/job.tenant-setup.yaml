{{- if and .Values.indexer.multiTenancy .Values.indexer.multiTenancy.enabled }}
{{- $multiTenancy := .Values.indexer.multiTenancy }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "common.names.fullname" $ }}-tenant-setup
  namespace: {{ include "common.names.namespace" $ }}
  annotations:
    {{- include "common.annotations.standard" ( dict "customAnnotations" .Values.commonAnnotations "context" $ ) | nindent 4 }}
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "15"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  labels:
    {{- include "common.labels.standard" ( dict "customLabels" .Values.commonLabels "context" $ ) | nindent 4 }}
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        {{- include "common.labels.standard" ( dict "customLabels" .Values.commonLabels "context" $ ) | nindent 8 }}
        app: {{ include "common.names.fullname" $ }}-tenant-setup
    spec:
      restartPolicy: OnFailure
      containers:
        - name: tenant-setup
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |
              set -e

              DASHBOARD_URL="https://{{ include "common.names.fullname" $ }}-dashboard:5601"
              INDEXER_URL="https://{{ include "common.names.fullname" $ }}-indexer-api:9200"
              MAX_RETRIES=60
              RETRY_INTERVAL=5

              echo "=========================================="
              echo "Wazuh Tenant Setup"
              echo "=========================================="

              # Wait for dashboard to be ready
              echo "Waiting for dashboard to be ready..."
              for i in $(seq 1 $MAX_RETRIES); do
                if curl -ks "${DASHBOARD_URL}/api/status" | grep -q "available"; then
                  echo "Dashboard is ready!"
                  break
                fi
                if [ $i -eq $MAX_RETRIES ]; then
                  echo "WARNING: Dashboard not ready, continuing anyway..."
                fi
                echo "Attempt $i/$MAX_RETRIES: Dashboard not ready, waiting ${RETRY_INTERVAL}s..."
                sleep $RETRY_INTERVAL
              done

              # Function to create index pattern in a tenant
              create_index_pattern() {
                local tenant="$1"
                local pattern="$2"
                local title="$3"
                local time_field="$4"

                echo "Creating index pattern '$pattern' in tenant '$tenant'..."

                # Create index pattern via saved objects API
                curl -ks -u "${ADMIN_USER}:${ADMIN_PASS}" \
                  -XPOST "${DASHBOARD_URL}/api/saved_objects/index-pattern/${pattern}" \
                  -H "Content-Type: application/json" \
                  -H "osd-xsrf: true" \
                  -H "securitytenant: ${tenant}" \
                  -d "{
                    \"attributes\": {
                      \"title\": \"${pattern}\",
                      \"timeFieldName\": \"${time_field}\"
                    }
                  }" || echo "Index pattern may already exist"
              }

              # Create default index patterns for each tenant
              {{- range $tenantName, $tenant := $multiTenancy.tenants }}
              echo ""
              echo "Setting up tenant: {{ $tenantName }}"
              echo "----------------------------------------"

              # Create wazuh-alerts-* index pattern
              create_index_pattern "{{ $tenantName }}" "wazuh-alerts-*" "Wazuh Alerts" "timestamp"

              # Create wazuh-archives-* index pattern (if archives enabled)
              create_index_pattern "{{ $tenantName }}" "wazuh-archives-*" "Wazuh Archives" "timestamp"

              # Create wazuh-monitoring-* index pattern
              create_index_pattern "{{ $tenantName }}" "wazuh-monitoring-*" "Wazuh Monitoring" "timestamp"

              {{- end }}

              echo ""
              echo "=========================================="
              echo "Tenant setup complete!"
              echo "=========================================="
              echo ""
              echo "Tenants configured:"
              {{- range $tenantName, $tenant := $multiTenancy.tenants }}
              echo "  - {{ $tenantName }}: {{ $tenant.description }}"
              {{- end }}
          env:
            - name: ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: {{ include "secret.indexer-auth" $ }}
                  key: INDEXER_USERNAME
            - name: ADMIN_PASS
              valueFrom:
                secretKeyRef:
                  name: {{ include "secret.indexer-auth" $ }}
                  key: INDEXER_PASSWORD
{{- end }}

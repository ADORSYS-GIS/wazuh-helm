{{- if and .Values.indexer.multiTenancy .Values.indexer.multiTenancy.enabled .Values.indexer.multiTenancy.agentGroups }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "common.names.fullname" $ }}-agent-enrichment
  namespace: {{ include "common.names.namespace" $ }}
  annotations:
    {{- include "common.annotations.standard" ( dict "customAnnotations" .Values.commonAnnotations "context" $ ) | nindent 4 }}
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "25"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  labels:
    {{- include "common.labels.standard" ( dict "customLabels" .Values.commonLabels "context" $ ) | nindent 4 }}
    app.kubernetes.io/component: agent-enrichment
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        {{- include "common.labels.standard" ( dict "customLabels" .Values.commonLabels "context" $ ) | nindent 8 }}
        app.kubernetes.io/component: agent-enrichment
    spec:
      restartPolicy: OnFailure
      containers:
        - name: agent-enrichment
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |
              set -e

              INDEXER_URL="https://{{ include "common.names.fullname" $ }}-indexer-api:9200"
              WAZUH_API_URL="https://{{ include "common.names.fullname" $ }}:55000"
              MAX_RETRIES=60
              RETRY_INTERVAL=5

              echo "==========================================="
              echo "Wazuh Agent Enrichment Pipeline Setup"
              echo "==========================================="

              # Wait for indexer to be ready
              echo "Waiting for indexer..."
              for i in $(seq 1 $MAX_RETRIES); do
                if curl -ks -u "${INDEXER_USERNAME}:${INDEXER_PASSWORD}" "${INDEXER_URL}/_cluster/health" | grep -qE '"status":"(green|yellow)"'; then
                  echo "Indexer is ready!"
                  break
                fi
                if [ $i -eq $MAX_RETRIES ]; then
                  echo "ERROR: Indexer not ready"
                  exit 1
                fi
                sleep $RETRY_INTERVAL
              done

              # Wait for Wazuh API
              echo "Waiting for Wazuh Manager API..."
              for i in $(seq 1 $MAX_RETRIES); do
                AUTH_RESPONSE=$(curl -ks -X POST "${WAZUH_API_URL}/security/user/authenticate" \
                  -u "${API_USERNAME}:${API_PASSWORD}" \
                  -H "Content-Type: application/json" 2>&1) || true
                if echo "$AUTH_RESPONSE" | grep -q '"token"'; then
                  echo "Wazuh API is ready!"
                  break
                fi
                if [ $i -eq $MAX_RETRIES ]; then
                  echo "ERROR: Wazuh API not ready"
                  exit 1
                fi
                sleep $RETRY_INTERVAL
              done

              # Get Wazuh API token
              AUTH_RESPONSE=$(curl -ks -X POST "${WAZUH_API_URL}/security/user/authenticate" \
                -u "${API_USERNAME}:${API_PASSWORD}" \
                -H "Content-Type: application/json")
              TOKEN="${AUTH_RESPONSE#*\"token\": \"}"
              TOKEN="${TOKEN%%\"*}"

              # Get agent-group mappings from Wazuh API
              echo "Fetching agent-group mappings..."
              AGENTS_JSON=$(curl -ks -X GET "${WAZUH_API_URL}/agents?select=id,group&limit=1000" \
                -H "Authorization: Bearer ${TOKEN}" \
                -H "Content-Type: application/json")

              # Build painless script with agent mappings
              echo "Building enrichment pipeline..."

              # Extract agent IDs and groups, build the mapping string
              MAPPING_SCRIPT="Map groups = new HashMap();"

              # Parse agents and build mapping (simplified parsing for shell)
              echo "$AGENTS_JSON" | grep -oE '"id": "[^"]+", "group": \[[^\]]+\]' | while read -r line; do
                ID=$(echo "$line" | grep -oE '"id": "[^"]+"' | cut -d'"' -f4)
                GROUPS=$(echo "$line" | grep -oE '"group": \[[^\]]+\]' | sed 's/"group": //' | tr -d '[]"' | tr ',' ' ')
                if [ -n "$ID" ] && [ -n "$GROUPS" ]; then
                  GROUP_ARRAY=$(echo "$GROUPS" | awk '{for(i=1;i<=NF;i++) printf "\"%s\"%s", $i, (i<NF?", ":"")}')
                  echo "groups.put(\"$ID\", [$GROUP_ARRAY]);"
                fi
              done > /tmp/mappings.txt

              # Read mappings into variable
              MAPPINGS=$(cat /tmp/mappings.txt | tr '\n' ' ')

              # Create the pipeline JSON
              SCRIPT_SOURCE="Map groups = new HashMap(); ${MAPPINGS} if (ctx.agent != null && ctx.agent.id != null) { String agentId = ctx.agent.id; if (groups.containsKey(agentId)) { ctx.agent.groups = groups.get(agentId); } else { ctx.agent.groups = [\"default\"]; } }"

              # Create pipeline using a temp file to avoid escaping issues
              cat > /tmp/pipeline.json << EOFPIPE
              {
                "description": "Enrich Wazuh alerts with agent groups from Wazuh Manager",
                "processors": [
                  {
                    "script": {
                      "lang": "painless",
                      "source": "${SCRIPT_SOURCE}"
                    }
                  }
                ]
              }
              EOFPIPE

              echo "Creating/updating ingest pipeline..."
              RESULT=$(curl -ks -u "${INDEXER_USERNAME}:${INDEXER_PASSWORD}" \
                -XPUT "${INDEXER_URL}/_ingest/pipeline/enrich-agent-groups" \
                -H "Content-Type: application/json" \
                -d @/tmp/pipeline.json)

              if echo "$RESULT" | grep -q '"acknowledged":true'; then
                echo "Pipeline created/updated successfully!"
              else
                echo "Warning: Pipeline creation returned: $RESULT"
              fi

              # Apply pipeline to wazuh-alerts indices
              echo "Applying pipeline to alert indices..."
              curl -ks -u "${INDEXER_USERNAME}:${INDEXER_PASSWORD}" \
                -XPUT "${INDEXER_URL}/wazuh-alerts-*/_settings" \
                -H "Content-Type: application/json" \
                -d '{"index.default_pipeline": "enrich-agent-groups"}'

              # Create/update index template for future indices
              echo ""
              echo "Updating index template..."
              curl -ks -u "${INDEXER_USERNAME}:${INDEXER_PASSWORD}" \
                -XPUT "${INDEXER_URL}/_template/wazuh-alerts-enriched" \
                -H "Content-Type: application/json" \
                -d '{
                  "order": 1,
                  "index_patterns": ["wazuh-alerts-4.x-*"],
                  "settings": {
                    "index.default_pipeline": "enrich-agent-groups"
                  }
                }'

              # Optionally update existing alerts (can be slow for large datasets)
              echo ""
              echo "Updating existing alerts with agent groups..."
              curl -ks -u "${INDEXER_USERNAME}:${INDEXER_PASSWORD}" \
                -XPOST "${INDEXER_URL}/wazuh-alerts-*/_update_by_query?pipeline=enrich-agent-groups&conflicts=proceed&wait_for_completion=false" \
                -H "Content-Type: application/json" \
                -d '{"query": {"bool": {"must_not": {"exists": {"field": "agent.groups"}}}}}'

              echo ""
              echo "==========================================="
              echo "Agent enrichment setup complete!"
              echo "==========================================="
          env:
            - name: INDEXER_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ include "secret.indexer-auth" $ }}
                  key: INDEXER_USERNAME
            - name: INDEXER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "secret.indexer-auth" $ }}
                  key: INDEXER_PASSWORD
            - name: API_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ include "secret.api-auth" $ }}
                  key: API_USERNAME
            - name: API_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "secret.api-auth" $ }}
                  key: API_PASSWORD
          resources:
            limits:
              cpu: 200m
              memory: 256Mi
            requests:
              cpu: 100m
              memory: 128Mi
{{- end }}
